const $=(e,t)=>document["querySelector"+(t?"All":"")](e),fetchToJSON=async e=>{return await fetch(e).then(e=>e.json())},ord=e=>e+{e:"st",o:"nd",w:"rd",h:"th"}[new Intl.PluralRules("en",{type:"ordinal"}).select(e)[2]],createElement=(e,t,i)=>{let s=document.createElement(e);return t&&t.split(";").forEach(e=>{e&&(e=e.split(":"),s.setAttribute(e[0].trim(),e[1].trim()))}),s.innerHTML=i||"",s},wait=t=>new Promise(e=>setTimeout(e,t)),purify=e=>e.trim().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace("Ã¦","ae").toLowerCase();function shuffleArray(e){for(var t=e.length-1;0<t;t--){var i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e}function renderAnswer(i){let r=createElement("span","class:rendered-answer");const s=(e,t,i)=>{var s=t.split("|"),n=s[0],s=s[1];r.append(n),s&&r.append(createElement("span","class:answer-note",`(${s})`)),i!==(e??t).length-1&&r.append(", ")};return i.constructor===Array?i.forEach((e,t)=>s(i,e,t)):s("",i,-1),r}const map={n:"neuter",m:"masculine",f:"feminine",s:"singular",p:"plural",nom:"nominative",gen:"genitive",dat:"dative",acc:"accusative",abl:"ablative"};class Switcher{constructor(){return this.panes=$(".pane",1),this.triggers=$(".pane-trigger",1),this.history=[],this}listen(){this.indexPanes();for(const e of this.triggers)e.addEventListener("click",()=>this.showPane(e.dataset.pane));return this}indexPanes(){var e={};for(const t of this.panes)e[t.id]=t;this.panes=e}showPane(e){let t=this.panes[e];return(t=(t=e.startsWith(".")?this.history[1]:t)||this.panes[404]).classList.add("showing"),this.history[0]&&this.history[0].classList.remove("showing"),this.history.unshift(t),this}}let typeMap=["info","success","error"],queue=[],showing=!1,id=0,container=createElement("div","class:toast-container");$("#app").append(container);class Message{constructor(e,t,i,s){t=createElement("div","class:toast "+typeMap[t]);s&&t.append(createElement("h3","class:toast-header",s)),t.append(createElement("p","class:toast-description "+(s?"smaller":""),e)),this.el=t,this.duration=i,this.id=(id++).toString(16),queue.push(this),wantToShow(this.id)}}function wantToShow(){if(queue.length)return showing?setTimeout(wantToShow,queue[0].duration):void showMessage(queue[0]).then(()=>{queue.shift(),showing=!1,wantToShow()})}function showMessage({el:t,duration:i}){return new Promise(async e=>{container.append(t),showing=!0,await wait(i),t.classList.add("hidden"),wait(200).then(()=>{t.remove(),e()})})}class Grader{constructor(){}initialize(e,t){}gradeQuestion(e,t){var i,s;return!!t&&(t=purify(t),e.answer.constructor===Array?(i=(s=e.answer).some(e=>purify(e)===t),s=s.some(e=>this.equals(t,e)),i?2:s?1:0):(i=t===purify(e.answer),s=this.equals(t,e.answer),i?2:s?1:0))}equals(i,s){if((i=purify(i))!==(s=purify(s))){if(s<2)return!1;let t=1;for(let e=0;e<i.length;e++)if(i.charAt(e)!==s.charAt(e)&&--t<0)return!1}return!0}finish(e){console.log(e),window.latinstudier.switcher.showPane("quiz-results");let t=0;$("#quiz-results-questions-inner").innerHTML="";for(var[i,s]of e.entries()){var i=createElement("div","class:quiz-results-q",`${i+1}. ${s.question}: `),n=createElement("span","class:quiz-results-q-wrong",s.graded.userAnswer),r=createElement("span","class:quiz-results-q-correct");r.append(renderAnswer(s.answer)),0<s.graded.isCorrect?t++:i.append(n),i.append(r),$("#quiz-results-questions-inner").append(i)}$("#quiz-results-percentage").textContent=Math.round(t/e.length*1e3)/10,$("#quiz-results-num-correct").textContent=t,$("#quiz-results-total").textContent=e.length}}class Animator{constructor(e,t){this.outer=e,this.settings=t;e=this.outer.querySelector(".animator-inner");e&&e.remove(),this.inner=createElement("div","class:animator-inner"),this.outer.append(this.inner)}animateTo(t,i){var e=this.getHTMLDimensions(t);return this.outer.classList.add("hidden"),this.outer.style.width=Math.max(e.width,this.settings.minWidth||0)+"px",this.outer.style.height=e.height+"px",new Promise(e=>{wait(i).then(()=>{this.outer.replaceChild(t,this.inner),this.outer.classList.remove("hidden"),this.inner=t,e(t)})})}animateAppend(e,t){var i=this.inner.cloneNode(!0),i=(i.append(e),this.getHTMLDimensions(i));this.outer.style.width=i.width+"px",this.outer.style.height=i.height+"px",this.inner.append(e)}getHTMLDimensions(e){e.classList.add("invisible"),document.body.append(e);var t=e.getBoundingClientRect();return e.classList.remove("invisible"),e.remove(),t}}class WalkthroughMan{constructor(){this.curQuestionIndex=0,this.container=$(".quiz-content-outer"),this.btns={prev:$(".quiz-prev"),next:$(".quiz-next")},this.userAnswers=[],this.questionTransition=200,this.grader=new Grader,this.animator=new Animator(this.container,{minWidth:300})}initialize(e,t){this.questions=shuffleArray(e),this.options=t,this.timeTo=this.options.immediateGrade?1:2,this.options.immediateGrade&&(this.btns.next.innerHTML="Grade"),$("#count-total").textContent=this.questions.length,$("#count-current").textContent="1",this.loadQuestion(0,0,1).then(()=>this.defaultHeight=this.container.getBoundingClientRect().height),this.updateDisable(),this.btns.next.addEventListener("click",this.listen.next.bind(this)),this.btns.prev.addEventListener("click",this.listen.prev.bind(this))}toQuestion(e){this.options.immediateGrade&&(this.btns.next.innerHTML="Grade"),this.curQuestionIndex+=e,this.loadQuestion(this.curQuestionIndex,this.questionTransition,e)}loadQuestion(t,i,e){return this.questions[t]?($("#count-current").textContent=(t+1).toString(),this.questions[t].graded&&(this.timeTo=2),this.updateNextBtn(),this.curInput=this.questions[t].html.querySelector("input"),this.updateDisable(),new Promise(async e=>{await this.animator.animateTo(this.questions[t].html,i),this.listen.input(),e()})):(this.curQuestionIndex-=e,this.finishQuiz())}updateDisable(){0===this.curQuestionIndex?this.btns.prev.disabled=!0:this.btns.prev.disabled=!1,this.curInput?.value.replaceAll(" ","")||this.questions[this.curQuestionIndex].graded?this.btns.next.disabled=!1:this.btns.next.disabled=!0}updateNextBtn(){this.btns.next.innerHTML=["Grade","Next","Finish"][this.timeTo-1]}listen={next:()=>{if(1===this.timeTo)this.gradeQuestion(),this.timeTo=this.curQuestionIndex===this.questions.length-1?3:2;else if(2===this.timeTo)this.options.immediateGrade||this.gradeQuestion(),this.toQuestion.apply(this,[1,this.questionTransition]),this.options.immediateGrade&&(this.timeTo=1);else if(3===this.timeTo)return this.finishQuiz();this.updateNextBtn()},prev:()=>{this.toQuestion.apply(this,[-1,this.questionTransition])},input:()=>{onkeyup=e=>{if("Enter"===e.key)return this.btns.next.click()},this.curInput.onkeyup=e=>{this.updateDisable(),this.userAnswers[this.curQuestionIndex]={response:this.curInput.value,graded:null}}}};updateGrade(e,t){e=["wrong","partial-correct","correct"][e],this.curInput.disabled=!0,this.curInput.classList.add(e),e=createElement("div","class:quiz-correct-answer");e.append(renderAnswer(t)),this.animator.animateAppend(e,200)}gradeQuestion(){var e,t,i=this.questions[this.curQuestionIndex];i.graded&&!this.options.immediateGrade||(e=this.userAnswers.map(e=>e.response)[this.curQuestionIndex],t=this.grader.gradeQuestion(i,this.userAnswers.map(e=>e.response)[this.curQuestionIndex]),this.options.immediateGrade&&this.updateGrade(t,i.answer),this.questions[this.curQuestionIndex].graded={isCorrect:t,answer:i.answer,userAnswer:e},this.updateDisable())}finishQuiz(){this.grader.finish(this.questions),this.questions=[],this.timeTo=1,this.userAnswers=[],this.grader=new Grader}}function declensions(e,t){var i,s,n=[];for([i,s]of Object.entries(t)){var[r,a,o]=i.split("|");"-"!==s&&((r={question:toQuestion(e,r,a,o),answer:s}).html=generateDeclHTML(r),n.push(r))}return n}function generateDeclHTML(e){var e=createElement("h3","class:quiz-question-title",e.question),t=createElement("input","placeholder:What is it? Enter...;type:text;class:quiz-question-input"),i=createElement("h4","class:quiz-question-super","what's the ending?"),s=createElement("div","class:animator-inner");return s.append(i,e,t),s}function toQuestion(e,t,i,s){t=t.split("").map(e=>map[e]).join("/");return`${ord(e)} declension ${map[s]} ${map[i]} (${t})`}function vocab(t,i){var s=[];0===(i=+i)?i=t.length:-1===i&&(i=0),shuffleArray(t);for(let e=0;e<i;e++){var n=t[e];s.push({type:"vocab",question:n.word,answer:n.translation,html:generateVocabHTML(n)})}return s}function generateVocabHTML(e){var t=createElement("h3","class:quiz-question-title",""+e.word+(e.dictionary?", "+e.dictionary:"")),i=createElement("input","placeholder:What's the translation? Enter...;type:text;class:quiz-question-input"),e=createElement("h4","class:quiz-question-super","translate the "+e.type),s=createElement("div","class:animator-inner");return s.append(e,t,i),s}class Formulator{constructor(e){this.options=e,this.questions=[]}initialize(t,e){var i,s={};console.log(this.options.declensions);for(let e=0;e<Math.log2(16)+1;e++){var n=2**e;(n&this.options.declensions)==n&&(s[e]=t[e+1])}for(i in this.questions.push(...this.questionGenerators.vocab(e,this.options.vocabNum)),s)this.questions.push(...this.questionGenerators.declensions.bind(this)(+i+1,s[i]));(new WalkthroughMan).initialize(this.questions,this.options)}questionGenerators={vocab:vocab,declensions:declensions}}class Initializer{constructor(){return this.optEls={declensions:$(".quiz-declension-option",1),vocabNum:$(".quiz-vocab-count"),immediateGrade:$("#quiz-immediate-grade")},this.options={declensions:0,vocabNum:0,immediateGrade:!0},this}async initialize(e){this.settingsListen(),this.fetched=e}settingsListen(){for(const e of this.optEls.declensions)e.addEventListener("click",e=>{e.target.classList.toggle("selected"),this.options.declensions^=1<<+e.target.dataset.value-1});return $(".pane-trigger.quiz-begin").addEventListener("click",e=>{if(this.quizIsEmpty())return new Message("No declensions and/or vocabulary question number specified.",2,4e3),window.latinstudier.switcher.showPane("quiz-start");this.options.immediateGrade=this.optEls.immediateGrade.checked,this.options.vocabNum=this.optEls.vocabNum.value,new Formulator(this.options).initialize(this.fetched[0],this.fetched[1])}),this}quizIsEmpty=()=>!(this.options.declensions||this.optEls.vocabNum.value&&"-1"!==this.optEls.vocabNum.value)}var Quiz={Initializer:Initializer,Formulator:Formulator,WalkthroughMan:WalkthroughMan,Grader:Grader};class Loader{constructor(){this.pane=$(".pane#view"),this.options={type:$("#view-type"),declType:$("#view-declension-type")},this.vocabLoaded=!1}async initialize(t){$("#view-trigger").onclick=e=>this.update[this.options.type.value].apply(this,[t]),this.options.type.oninput=e=>{this.options.declType.classList.toggle("hidden"),this.update[e.target.value](t),$(".view-decl").style.display="vocab"===e.target.value?"none":"block",$(".view-vocab").style.display="vocab"!==e.target.value?"none":"block"},this.options.declType.oninput=e=>{this.update[this.options.type.value](t)}}update={declensions:([e])=>{var t,i,e=e[this.options.declType.value];let s=new Set;for([t,i]of Object.entries(e)){var[n,r,a]=t.split("|");"note"===t?$("#view-note").innerHTML=i:($(`.view-table-field.${map[n]}.${map[r]}.`+map[a]).textContent=i,s.add(n))}s=Array.from(s).map(e=>map[e]),Array.from($(".view-table-head, .view-table-field",1)).forEach(e=>e.style.display="table-cell"),Array.from($(`.view-table-head:not(.${s.join("):not(.")}), 
                    .view-table-field:not(.${s.join("):not(.")})`,1)).forEach(e=>e.style.display="none")},vocab:([,e])=>{if(!0!==this.vocabLoaded){for(const i of e){var t=createElement("div","class:view-vocab-word",""+i.word+(i.dictionary?", "+i.dictionary:""));t.dataset.declension=i.declension||"0",t.dataset.type=i.type||"other",t.append(renderAnswer(i.translation)),$(".view-vocab").append(t)}this.vocabLoaded=!0}}}}var View={Loader:Loader};class Studier{constructor(){this.switcher=new Switcher,this.loaders=[new Quiz.Initializer,new View.Loader];var e=fetchToJSON("./data/declensions.json"),t=fetchToJSON("./data/vocab.json");Promise.all([e,t]).then(e=>this.initialize(e))}initialize(t){this.switcher.listen().showPane("begin"),this.loaders.forEach(e=>e.initialize(t))}}window.latinstudier=new Studier;